var amf={CONST:{EMPTY_STRING:"",NULL_STRING:"null",UNDEFINED_TYPE:0,NULL_TYPE:1,FALSE_TYPE:2,TRUE_TYPE:3,INTEGER_TYPE:4,DOUBLE_TYPE:5,STRING_TYPE:6,XML_TYPE:7,DATE_TYPE:8,ARRAY_TYPE:9,OBJECT_TYPE:10,XMLSTRING_TYPE:11,BYTEARRAY_TYPE:12,AMF0_AMF3:17,UINT29_MASK:536870911,INT28_MAX_VALUE:268435455,INT28_MIN_VALUE:-268435456,CLASS_ALIAS:"_explicitType",EXTERNALIZED_FIELD:"_externalizedData"},requestPoolSize:6,requestPool:[],doNothing:new Function,ActionMessage:function(){return{_explicitType:"flex.messaging.io.amf.ActionMessage",version:3,headers:[],bodies:[]}},MessageBody:function(){return{targetURI:"null",responseURI:"/1",data:[]}},MessageHeader:function(){return{name:"",mustUnderstand:!1,data:null}},CommandMessage:function(){return{_explicitType:"flex.messaging.messages.CommandMessage",destination:"",operation:5,clientId:null}},RemotingMessage:function(){return{_explicitType:"flex.messaging.messages.RemotingMessage",destination:"",source:"",operation:"",body:[],headers:{DSId:"nil"},clientId:null}},AcknowledgeMessage:function(){return{_explicitType:"flex.messaging.messages.AcknowledgeMessage",body:null,headers:[],messageId:null,clientId:null}},PendingRequest:function(t,e,r,i,a){return{source:t,operation:e,params:r,onResult:i,onStatus:a}}};amf.Client=function(t,e,r){this.requestTimeout=r?r:3e4,this.messageQueue=[],this.sendMessageId=!0,this.clientId=null,this.sequence=1,this.destination=t,this.endpoint=e,this.headers=null},amf.Client.prototype.addHeader=function(t,e){var r={};r[t]=e,this.headers.push(r)},amf.Client.prototype.createMessage=function(t){var e,r=new amf.ActionMessage,i=new amf.MessageBody;if("command"==t.source&&"ping"==t.operation)this.sequence=1,i.responseURI="/"+this.sequence++,e=new amf.CommandMessage,e.destination=this.destination;else if(i.responseURI="/"+this.sequence++,e=new amf.RemotingMessage,e.destination=this.destination,e.source=t.source,e.operation=t.operation,e.body=t.params,this.sendMessageId&&(e.messageId=amf.uuid(0,0)),e.headers.DSId=this.clientId,e.clientId=this.clientId,"[object Array]"===Object.prototype.toString.call(this.headers))for(var a=0;a<this.headers.length;a++){var s=this.headers[a];for(var n in s)e.headers[n]=s[n]}return i.data.push(e),r.bodies.push(i),r},amf.Client.prototype.invoke=function(t,e,r,i,a){null==this.clientId&&0==this.messageQueue.length&&(this.messageQueue.push(new amf.PendingRequest("command","ping",r,i,a)),this._processQueue()),this.messageQueue.push(new amf.PendingRequest(t,e,r,i,a)),null!=this.clientId&&this._processQueue()},amf.Client.prototype._processQueue=function(){var t,e;for(t=0;t<amf.requestPoolSize&&this.messageQueue.length>0;t++)if(amf.requestPool.length==t?(e=new XMLHttpRequest,e.parent=this,e.busy=!1,amf.requestPool.push(e)):e=amf.requestPool[t],!e.busy){var r=this.messageQueue.shift();if(this._send(e,r),"command"==r.source&&"ping"==r.operation)return}},amf.Client.prototype._send=function(t,e){var r=this.createMessage(e),i=new amf.Serializer;t.message=i.writeMessage(r),t.onreadystatechange=function(){if(1===this.readyState)this.busy||(this.busy=!0,this.setRequestHeader("Content-Type","application/x-amf; charset=UTF-8"),this.responseType="arraybuffer",this.send(new Uint8Array(t.message)));else if(4===this.readyState){this.onreadystatechange=amf.doNothing;try{if(this.status>=200&&this.status<=300&&"arraybuffer"==this.responseType&&this.getResponseHeader("Content-type").indexOf("application/x-amf")>-1){var r=new amf.Deserializer(new Uint8Array(this.response)),i=r.readMessage();for(var a in i.bodies){var s=i.bodies[a];s.targetURI&&s.targetURI.indexOf("/onResult")>-1?"/1/onResult"==s.targetURI?this.parent.clientId=s.data.clientId:e.onResult(s.data.body):"flex.messaging.messages.ErrorMessage"==s.data._explicitType&&e.onStatus({faultCode:s.data.faultCode,faultDetail:s.data.faultDetail,faultString:s.data.faultString})}this.busy=!1,this.message=null,this.parent._processQueue()}else e.onStatus(0==this.status||""!=this.responseType&&"text"==this.responseType?{faultCode:0,faultDetail:"Invalid XMLHttpRequest response status or type.",faultString:"Invalid Response."}:{faultCode:1,faultDetail:this.responseText,faultString:"Invalid Response."})}catch(n){e.onStatus({faultCode:2,faultDetail:"",faultString:"Unknown Error."})}}},t.open("POST",this.endpoint,!0)},amf.Writer=function(){this.data=[],this.objects=[],this.traits={},this.strings={},this.stringCount=0,this.traitCount=0,this.objectCount=0},amf.Writer.prototype.write=function(t){this.data.push(t)},amf.Writer.prototype.writeShort=function(t){this.write(t>>>8&255),this.write(t>>>0&255)},amf.Writer.prototype.writeUTF=function(t,e){var r,i,a,s,n;for(s=t.length,n=0,a=0;s>a;a++)i=t.charCodeAt(a),i>0&&128>i?n++:n+=i>2047?3:2;for(r=[],e?this.writeUInt29(n<<1|1):(r.push(n>>>8&255),r.push(255&n)),a=0;s>a;a++)i=t.charCodeAt(a),i>0&&128>i?r.push(i):i>2047?(r.push(224|i>>12),r.push(128|i>>6&63),r.push(e?128|i>>0&63:128|63&i)):(r.push(192|i>>6),r.push(e?128|i>>0&63:128|63&i));return this.writeAll(r),e?n:n+2},amf.Writer.prototype.writeUInt29=function(t){if(128>t)this.write(t);else if(16384>t)this.write(t>>7&127|128),this.write(127&t);else if(2097152>t)this.write(t>>14&127|128),this.write(t>>7&127|128),this.write(127&t);else{if(!(1073741824>t))throw"Integer out of range: "+t;this.write(t>>22&127|128),this.write(t>>15&127|128),this.write(t>>8&127|128),this.write(255&t)}},amf.Writer.prototype.writeAll=function(t){for(var e=0;e<t.length;e++)this.write(t[e])},amf.Writer.prototype.writeBoolean=function(t){this.write(t?1:0)},amf.Writer.prototype.writeInt=function(t){this.write(t>>>24&255),this.write(t>>>16&255),this.write(t>>>8&255),this.write(t>>>0&255)},amf.Writer.prototype.writeUnsignedInt=function(t){0>t&&(t=-(4294967295^t)-1),t&=4294967295,this.write(t>>24&255),this.write(t>>16&255),this.write(t>>8&255),this.write(255&t)},amf.Writer.prototype._getDouble=function(t){var e=[0,0];if(t!=t)return e[0]=-524288,e;var r=0>t||0===t&&0>1/t?-2147483648:0,t=Math.abs(t);if(t===Number.POSITIVE_INFINITY)return e[0]=2146435072|r,e;for(var i=0;t>=2&&1023>=i;)i++,t/=2;for(;1>t&&i>=-1022;)i--,t*=2;if(i+=1023,2047==i)return e[0]=2146435072|r,e;var a;return 0==i?(a=t*Math.pow(2,23)/2,t=Math.round(t*Math.pow(2,52)/2)):(a=t*Math.pow(2,20)-Math.pow(2,20),t=Math.round(t*Math.pow(2,52)-Math.pow(2,52))),e[0]=r|i<<20&2147418112|1048575&a,e[1]=t,e},amf.Writer.prototype.writeDouble=function(t){t=this._getDouble(t),this.writeUnsignedInt(t[0]),this.writeUnsignedInt(t[1])},amf.Writer.prototype.getResult=function(){return this.data.join("")},amf.Writer.prototype.reset=function(){this.objects=[],this.objectCount=0,this.traits={},this.traitCount=0,this.strings={},this.stringCount=0},amf.Writer.prototype.writeStringWithoutType=function(t){0==t.length?this.writeUInt29(1):this.stringByReference(t)||this.writeUTF(t,!0)},amf.Writer.prototype.stringByReference=function(t){var e=this.strings[t];return e?this.writeUInt29(e<<1):this.strings[t]=this.stringCount++,e},amf.Writer.prototype.objectByReference=function(t){for(var e=0,r=!1;e<this.objects.length;e++)if(this.objects[e]===t){r=!0;break}return r?this.writeUInt29(e<<1):(this.objects.push(t),this.objectCount++),r?e:null},amf.Writer.prototype.traitsByReference=function(t,e){for(var r=e+"|",i=0;i<t.length;i++)r+=t[i]+"|";var a=this.traits[r];return a?this.writeUInt29(a<<2|1):this.traits[r]=this.traitCount++,a},amf.Writer.prototype.writeAmfInt=function(t){t>=amf.CONST.INT28_MIN_VALUE&&t<=amf.CONST.INT28_MAX_VALUE?(t&=amf.CONST.UINT29_MASK,this.write(amf.CONST.INTEGER_TYPE),this.writeUInt29(t)):(this.write(amf.CONST.DOUBLE_TYPE),this.writeDouble(t))},amf.Writer.prototype.writeDate=function(t){this.write(amf.CONST.DATE_TYPE),this.objectByReference(t)||(this.writeUInt29(1),this.writeDouble(t.getTime()))},amf.Writer.prototype.writeObject=function(t){return null==t?void this.write(amf.CONST.NULL_TYPE):void(t.constructor===String?(this.write(amf.CONST.STRING_TYPE),this.writeStringWithoutType(t)):t.constructor===Number?t===+t&&t===(0|t)?this.writeAmfInt(t):(this.write(amf.CONST.DOUBLE_TYPE),this.writeDouble(t)):t.constructor===Boolean?this.write(t?amf.CONST.TRUE_TYPE:amf.CONST.FALSE_TYPE):t.constructor===Date?this.writeDate(t):t.constructor===Array?this.writeArray(t):amf.CONST.CLASS_ALIAS in t?this.writeCustomObject(t):this.writeMap(t))},amf.Writer.prototype.writeCustomObject=function(t){if(this.write(amf.CONST.OBJECT_TYPE),!this.objectByReference(t))for(var e=this.writeTraits(t),r=0;r<e.length;r++){var i=e[r];this.writeObject(t[i])}},amf.Writer.prototype.writeTraits=function(t){var e=[],r=0,i=!1,a=!1;for(var s in t)s!=amf.CONST.CLASS_ALIAS&&(e.push(s),r++);if(!this.traitsByReference(e,t[amf.CONST.CLASS_ALIAS])&&(this.writeUInt29(3|(i?4:0)|(a?8:0)|r<<4),this.writeStringWithoutType(t[amf.CONST.CLASS_ALIAS]),r>0))for(var n in e)this.writeStringWithoutType(e[n]);return e},amf.Writer.prototype.writeMap=function(t){if(this.write(amf.CONST.OBJECT_TYPE),!this.objectByReference(t)){this.writeUInt29(11),this.traitCount++,this.writeStringWithoutType(amf.CONST.EMPTY_STRING);for(var e in t)this.writeStringWithoutType(e?e:amf.CONST.EMPTY_STRING),this.writeObject(t[e]);this.writeStringWithoutType(amf.CONST.EMPTY_STRING)}},amf.Writer.prototype.writeArray=function(t){if(this.write(amf.CONST.ARRAY_TYPE),!this.objectByReference(t)&&(this.writeUInt29(t.length<<1|1),this.writeUInt29(1),t.length>0))for(var e=0;e<t.length;e++)this.writeObject(t[e])},amf.Reader=function(t){this.objects=[],this.traits=[],this.strings=[],this.data=t,this.pos=0},amf.Reader.prototype.read=function(){return this.data[this.pos++]},amf.Reader.prototype.readUnsignedShort=function(){var t=this.read(),e=this.read();return(t<<8)+(e<<0)},amf.Reader.prototype.readUInt29=function(){var t=255&this.read();if(128>t)return t;var e=(127&t)<<7;return t=255&this.read(),128>t?e|t:(e=(e|127&t)<<7,t=255&this.read(),128>t?e|t:(e=(e|127&t)<<8,t=255&this.read(),e|t))},amf.Reader.prototype.readFully=function(t,e,r){for(var i=e;r>i;i++)t[i]=this.read()},amf.Reader.prototype.readUTF=function(t){for(var e,r,i,a=t?t:this.readUnsignedShort(),s=[],n=this.pos;this.pos<n+a;)e=this.read(),128>e?s.push(String.fromCharCode(e)):e>2047?(r=this.read(),i=this.read(),s.push(String.fromCharCode((15&e)<<12|(63&r)<<6|63&i))):(r=this.read(),s.push(String.fromCharCode((31&e)<<6|63&r)));return s.join("")},amf.Reader.prototype.reset=function(){this.objects=[],this.traits=[],this.strings=[]},amf.Reader.prototype.readObject=function(){var t=this.read();return this.readObjectValue(t)},amf.Reader.prototype.readString=function(){var t=this.readUInt29();if(0==(1&t))return this.getString(t>>1);var e=t>>1;if(0==e)return amf.CONST.EMPTY_STRING;var r=this.readUTF(e);return this.rememberString(r),r},amf.Reader.prototype.rememberString=function(t){this.strings.push(t)},amf.Reader.prototype.getString=function(t){return this.strings[t]},amf.Reader.prototype.getObject=function(t){return this.objects[t]},amf.Reader.prototype.getTraits=function(t){return this.traits[t]},amf.Reader.prototype.rememberTraits=function(t){this.traits.push(t)},amf.Reader.prototype.rememberObject=function(t){this.objects.push(t)},amf.Reader.prototype.readTraits=function(t){if(1==(3&t))return this.getTraits(t>>2);var e=t>>4,r=this.readString(),i={};null!=r&&""!=r&&(i[amf.CONST.CLASS_ALIAS]=r),i.props=[];for(var a=0;e>a;a++)i.props.push(this.readString());return this.rememberTraits(i),i},amf.Reader.prototype.readScriptObject=function(){var t=this.readUInt29();if(0==(1&t))return this.getObject(t>>1);var e=this.readTraits(t),r={};if(amf.CONST.CLASS_ALIAS in e&&(r[amf.CONST.CLASS_ALIAS]=e[amf.CONST.CLASS_ALIAS]),this.rememberObject(r),4==(4&t)){if("flex.messaging.io.ArrayCollection"==r[amf.CONST.CLASS_ALIAS]||"flex.messaging.io.ObjectProxy"==r[amf.CONST.CLASS_ALIAS])return this.readObject();r[amf.CONST.EXTERNALIZED_FIELD]=this.readObject()}else{for(var i in e.props)r[e.props[i]]=this.readObject();if(8==(8&t))for(;;){var a=this.readString();if(null==a||0==a.length)break;r[a]=this.readObject()}}return r},amf.Reader.prototype.readArray=function(){var t=this.readUInt29();if(0==(1&t))return this.getObject(t>>1);for(var e=t>>1,r=null,i=0;;){var a=this.readString();if(!a)break;r||(r={},this.rememberObject(r)),r[a]=this.readObject()}if(r){for(i=0;e>i;i++)r[i]=this.readObject();return r}var s=new Array(e);for(this.rememberObject(s),i=0;e>i;i++)s[i]=this.readObject();return s},amf.Reader.prototype.readDouble=function(){var t=255&this.read(),e=255&this.read();if(255===t){if(248===e)return Number.NaN;if(240===e)return Number.NEGATIVE_INFINITY}else if(127===t&&240===e)return Number.POSITIVE_INFINITY;var r=255&this.read(),i=255&this.read(),a=255&this.read(),s=255&this.read(),n=255&this.read(),o=255&this.read();if(!(t||e||r||i))return 0;for(var h=(t<<4&2047|e>>4)-1023,e=((15&e)<<16|r<<8|i).toString(2),r=e.length;20>r;r++)e="0"+e;for(s=((127&a)<<24|s<<16|n<<8|o).toString(2),r=s.length;31>r;r++)s="0"+s;return a=parseInt(e+(a>>7?"1":"0")+s,2),0==a&&-1023==h?0:(1-(t>>7<<1))*(1+Math.pow(2,-52)*a)*Math.pow(2,h)},amf.Reader.prototype.readDate=function(){var t=this.readUInt29();if(0==(1&t))return this.getObject(t>>1);var e=this.readDouble(),r=new Date(e);return this.rememberObject(r),r},amf.Reader.prototype.readMap=function(){var t=this.readUInt29();if(0==(1&t))return this.getObject(t>>1);var e=t>>1,r=null;if(e>0){r={},this.rememberObject(r);for(var i=this.readObject();null!=i;)r[i]=this.readObject(),i=this.readObject()}return r},amf.Reader.prototype.readByteArray=function(){var t=this.readUInt29();if(0==(1&t))return this.getObject(t>>1);var e=t>>1,r=[];return this.readFully(r,0,e),this.rememberObject(r),r},amf.Reader.prototype.readObjectValue=function(t){var e=null;switch(t){case amf.CONST.STRING_TYPE:e=this.readString();break;case amf.CONST.OBJECT_TYPE:try{e=this.readScriptObject()}catch(r){throw"Failed to deserialize:"+r}break;case amf.CONST.ARRAY_TYPE:e=this.readArray();break;case amf.CONST.FALSE_TYPE:e=!1;break;case amf.CONST.TRUE_TYPE:e=!0;break;case amf.CONST.INTEGER_TYPE:e=this.readUInt29(),e=e<<3>>3;break;case amf.CONST.DOUBLE_TYPE:e=this.readDouble();break;case amf.CONST.UNDEFINED_TYPE:case amf.CONST.NULL_TYPE:break;case amf.CONST.DATE_TYPE:e=this.readDate();break;case amf.CONST.BYTEARRAY_TYPE:e=this.readByteArray();break;case amf.CONST.AMF0_AMF3:e=this.readObject();break;default:throw"Unknown AMF type: "+t}return e},amf.Reader.prototype.readBoolean=function(){return 1===this.read()},amf.Serializer=function(){this.writer=new amf.Writer},amf.Serializer.prototype.writeMessage=function(t){try{this.writer.writeShort(t.version),this.writer.writeShort(t.headers.length);for(var e in t.headers)this.writeHeader(t.headers[e]);this.writer.writeShort(t.bodies.length);for(var r in t.bodies)this.writeBody(t.bodies[r])}catch(i){console.log(i)}return this.writer.data},amf.Serializer.prototype.writeObject=function(t){this.writer.writeObject(t)},amf.Serializer.prototype.writeHeader=function(t){this.writer.writeUTF(t.name),this.writer.writeBoolean(t.mustUnderstand),this.writer.writeInt(1),this.writer.reset(),this.writer.write(1),this.writer.writeBoolean(!0)},amf.Serializer.prototype.writeBody=function(t){this.writer.writeUTF(null==t.targetURI?amf.CONST.NULL_STRING:t.targetURI),this.writer.writeUTF(null==t.responseURI?amf.CONST.NULL_STRING:t.responseURI),this.writer.writeInt(1),this.writer.reset(),this.writer.write(amf.CONST.AMF0_AMF3),this.writeObject(t.data)},amf.Deserializer=function(t){this.reader=new amf.Reader(t)},amf.Deserializer.prototype.readMessage=function(){var t=new amf.ActionMessage;t.version=this.reader.readUnsignedShort();for(var e=this.reader.readUnsignedShort(),r=0;e>r;r++)t.headers.push(this.readHeader());var i=this.reader.readUnsignedShort();for(r=0;i>r;r++)t.bodies.push(this.readBody());return t},amf.Deserializer.prototype.readHeader=function(){var t=new amf.MessageHeader;t.name=this.reader.readUTF(),t.mustUnderstand=this.reader.readBoolean(),this.reader.pos+=4,this.reader.reset();var e=this.reader.read();if(2!=e)throw"Only string header data supported.";return t.data=this.reader.readUTF(),t},amf.Deserializer.prototype.readBody=function(){var t=new amf.MessageBody;return t.targetURI=this.reader.readUTF(),t.responseURI=this.reader.readUTF(),this.reader.pos+=4,this.reader.reset(),t.data=this.readObject(),t},amf.Deserializer.prototype.readObject=function(){return this.reader.readObject()},amf.uuid=function t(e,r){return e?(r|16*Math.random()>>r/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/1|0|(8)/g,t)};
